# K8s 多集群资源监控与分析系统需求文档 v2.0

## 项目概述
开发一个企业级 K8s 多集群资源监控分析平台，支持多个集群的统一管理、定时监控、历史数据存储和智能分析，用于识别和优化集群中的资源配置问题。

## 核心功能需求

### 1. 多集群管理功能
- **集群配置管理**
  - 支持添加、编辑、删除多个 K8s 集群配置
  - 安全存储集群连接信息（API Server地址、认证证书、Token等）
  - 集群状态监控（在线/离线检测）
  - 集群分组和标签管理
  - 支持不同版本的 K8s 集群

- **多集群统一视图**
  - 跨集群资源统计和对比
  - 集群间资源利用率排名
  - 多集群问题 Pod 汇总展示
  - 集群切换和筛选功能

### 2. 数据持久化存储
- **数据库设计**
  - 集群配置表（cluster_configs）
  - Pod 资源监控历史表（pod_metrics_history）
  - 告警规则配置表（alert_rules）
  - 告警历史记录表（alert_history）
  - 系统配置表（system_settings）

- **数据存储策略**
  - 支持 MySQL/PostgreSQL 作为主存储
  - 可配置数据保留周期（默认30天）
  - 自动数据清理和归档机制
  - 支持数据备份和恢复

### 3. 定时监控系统
- **可配置采集周期**
  - 支持分钟级、小时级、日级采集频率
  - 不同集群可设置不同采集频率
  - 支持手动触发即时采集
  - 采集任务状态监控和错误重试

- **监控数据管理**
  - 实时数据采集和存储
  - 历史数据查询和分析
  - 数据完整性检查
  - 采集性能监控

### 4. 智能分析与告警
- **增强的分析算法**
  - 基于历史数据的趋势分析
  - 资源使用模式识别
  - 异常检测算法
  - 成本优化建议生成

- **告警系统**
  - 可配置告警规则（利用率阈值、配置缺失等）
  - 多种告警方式（邮件、webhook、钉钉等）
  - 告警聚合和去重
  - 告警历史追踪

### 5. 高级数据展示
- **仪表板功能**
  - 多集群概览仪表板
  - 资源利用率趋势图表
  - Top N 问题 Pod 排行榜
  - 成本分析图表

- **报告系统**
  - 自动生成周期性报告
  - 支持 PDF/Excel 格式导出
  - 自定义报告模板
  - 邮件定时推送报告

## 技术架构需求

### 1. 后端架构
- **微服务设计**
  - 集群管理服务
  - 数据采集服务
  - 分析计算服务
  - 告警服务
  - 报告服务

- **技术栈**
  - Go + Gin 框架
  - MySQL/PostgreSQL 数据库
  - Redis 缓存
  - 定时任务调度器
  - 消息队列（可选）

### 2. 前端架构
- **现代化 Web 界面**
  - Vue.js 3 + TypeScript
  - 响应式设计，支持移动端
  - 图表组件（ECharts/Chart.js）
  - 实时数据更新

### 3. 部署方案
- **容器化部署**
  - Docker 镜像构建
  - Docker Compose 一键部署
  - Kubernetes 集群部署支持
  - Helm Chart 包管理

## 功能优先级与实施计划

### 第一阶段：核心基础功能（2周）
1. **多集群配置管理**
   - 数据库设计和初始化
   - 集群 CRUD 操作 API
   - 集群连接测试功能

2. **数据持久化改造**
   - 将现有单集群代码改造为多集群支持
   - 实现数据库存储逻辑
   - 历史数据查询 API

### 第二阶段：定时监控与分析（2周）
1. **定时采集系统**
   - 实现可配置的定时任务
   - 多集群并行数据采集
   - 错误处理和重试机制

2. **增强分析功能**
   - 历史趋势分析算法
   - 多集群对比分析
   - 成本计算功能

### 第三阶段：告警与可视化（2周）
1. **告警系统**
   - 告警规则配置
   - 多渠道通知实现
   - 告警状态管理

2. **前端界面升级**
   - 多集群切换界面
   - 图表和仪表板
   - 报告生成功能

### 第四阶段：优化与扩展（1周）
1. **性能优化**
   - 数据库查询优化
   - 缓存策略实现
   - 并发处理优化

2. **扩展功能**
   - 用户权限管理
   - 审计日志
   - API 文档

## 数据模型设计

### 集群配置表（cluster_configs）
```sql
- id: 主键
- cluster_name: 集群名称
- cluster_alias: 集群别名
- api_server: API Server 地址
- auth_type: 认证类型（token/cert/kubeconfig）
- auth_config: 认证配置（JSON）
- status: 集群状态
- tags: 集群标签
- collect_interval: 采集间隔（分钟）
- created_at/updated_at: 时间戳
```

### Pod 监控历史表（pod_metrics_history）
```sql
- id: 主键
- cluster_id: 集群ID
- namespace: 命名空间
- pod_name: Pod名称
- node_name: 节点名称
- memory_usage/request/limit: 内存相关
- cpu_usage/request/limit: CPU相关
- status: 状态（合理/不合理）
- issues: 问题描述（JSON）
- collected_at: 采集时间
```

## 配置管理

### 系统配置项
- **数据保留策略**：历史数据保留天数（默认30天）
- **采集配置**：默认采集间隔、并发数限制
- **告警配置**：告警阈值、通知渠道配置
- **报告配置**：报告生成周期、邮件模板

### 告警规则配置
- **资源利用率告警**：低利用率阈值设置
- **配置缺失告警**：未设置 requests/limits 检测
- **集群异常告警**：集群连接失败、采集异常

## 安全考虑

### 数据安全
- 集群认证信息加密存储
- API 接口认证和授权
- 敏感数据脱敏处理
- 审计日志记录

### 网络安全
- HTTPS 通信加密
- 集群访问权限最小化
- 防火墙规则配置
- 访问频率限制

## 性能指标

### 系统性能目标
- **响应时间**：Web 界面响应 < 2秒
- **采集性能**：单集群采集时间 < 30秒
- **并发支持**：支持同时监控 20+ 集群
- **数据处理**：支持 10万+ Pod 的数据分析

### 资源消耗
- **内存使用**：< 1GB 运行内存
- **存储需求**：每万个 Pod 每天约 100MB 数据
- **CPU 使用**：采集期间 CPU 使用率 < 50%

## 预期效果与价值

### 业务价值
- **成本节约**：通过资源优化减少 20-30% 云资源成本
- **运维效率**：自动化监控减少 80% 手动检查工作
- **决策支持**：提供数据驱动的资源规划建议
- **风险控制**：提前发现资源配置问题，避免生产事故

### 技术价值
- **统一管理**：多集群统一监控和管理平台
- **历史追踪**：完整的资源使用历史数据
- **智能分析**：基于机器学习的异常检测
- **可扩展性**：支持集群规模和功能的灵活扩展

## 新增功能需求 v2.1

### 6. 资源使用量统计功能
- **Top资源使用统计**
  - 内存请求最大的前50个Pod（按从大到小排序）
  - CPU请求最大的前50个Pod（按从大到小排序）
  - 支持跨集群统计和单集群统计
  - 提供资源使用量、请求量、限制量的完整信息

### 7. 命名空间详情功能  
- **命名空间级监控**
  - 点击命名空间跳转到专用详情页面
  - 树状图展示当前命名空间下所有Pod的资源使用情况
  - 显示Pod的内存/CPU使用量、请求量、限制量及利用率
  - 支持命名空间级别的资源统计和分析

### 8. Pod搜索与分页功能
- **增强的Pod管理**
  - 展示所有命名空间下的Pod列表
  - 支持按Pod名称进行实时搜索
  - 支持按命名空间、集群名称等维度筛选
  - 分页显示支持（10/30/50条每页）
  - 默认显示10条记录

### API接口设计

#### 资源统计接口
```
GET /api/v1/statistics/top-memory-request?limit=50    // Top内存请求Pod
GET /api/v1/statistics/top-cpu-request?limit=50       // Top CPU请求Pod  
GET /api/v1/statistics/namespace-summary              // 命名空间汇总统计
```

#### 命名空间详情接口
```
GET /api/v1/namespaces/{namespace}/pods               // 获取命名空间下Pod列表
GET /api/v1/namespaces/{namespace}/tree-data          // 获取树状图数据
GET /api/v1/namespaces                                // 获取所有命名空间列表
```

#### Pod搜索分页接口
```
GET /api/v1/pods/search?query={podName}&namespace={ns}&page={page}&size={size}
GET /api/v1/pods/list?page={page}&size={size}         // 分页获取Pod列表
```

### 前端页面设计

#### 主页面增强
- 添加命名空间概览区域
- 显示各命名空间的Pod数量和资源使用概况
- 命名空间卡片支持点击跳转

#### 命名空间详情页面
- 页面路由：`/namespaces/{namespace-name}`
- 树状图组件展示Pod层次结构
- 资源使用情况表格和图表
- 面包屑导航支持返回主页

#### Pod管理页面  
- 页面路由：`/pods`
- 搜索框组件（支持实时搜索）
- 高级筛选器（命名空间、集群等）
- 分页组件（10/30/50条选择）
- 响应式表格展示Pod详细信息

### 实施优先级
1. **第一步**：实现后端API接口（资源统计、命名空间详情、搜索分页） ✅ **已完成**
2. **第二步**：开发前端页面组件（树状图、搜索、分页）
3. **第三步**：集成测试和用户体验优化

## 已完成功能 v2.2

### 9. 数据持久化存储功能 ✅
- **Pod监控历史表**
  - 完整的Pod资源监控历史数据模型
  - 支持内存/CPU使用量、请求量、限制量及利用率的历史记录
  - 关联集群配置和问题描述的JSON存储
  - 基于时间的索引优化查询性能

- **历史数据服务**
  - 批量保存Pod监控数据到数据库
  - 支持多维度查询（集群、命名空间、Pod名称、时间范围）
  - 分页查询历史数据
  - 趋势数据分析（指定时间范围内的变化趋势）
  - 自动清理过期数据（可配置保留天数）
  - 历史数据统计信息

### 10. 增强的数据收集功能 ✅
- **持久化支持**
  - 收集器支持可选的数据持久化
  - 自动保存所有集群的Pod监控数据
  - 实时数据收集与历史数据存储的解耦

### API接口增强 ✅

#### 历史数据接口
```
GET  /api/v1/history/query                    // 查询历史数据（支持多维度筛选和分页）
GET  /api/v1/history/trends                   // 获取趋势数据（指定时间范围）
GET  /api/v1/history/statistics               // 获取历史数据统计信息
POST /api/v1/history/collect                  // 手动触发数据收集（可选持久化）
DEL  /api/v1/history/cleanup                  // 清理过期历史数据
```

#### 查询参数支持
- **历史数据查询**：cluster_id, namespace, pod_name, start_time, end_time, page, size
- **趋势数据分析**：cluster_id, namespace, pod_name, hours
- **数据收集控制**：persistence (true/false)
- **数据清理配置**：retention_days

### 技术架构优化 ✅
- **避免循环依赖**：service层独立的数据结构定义
- **批量数据处理**：支持100条记录的批量插入优化
- **错误处理增强**：完善的错误提示和日志记录
- **数据转换层**：collector与service之间的数据格式转换