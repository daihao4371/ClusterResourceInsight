import{d as Z,r as C,a as $,o as ee,b as v,e as m,f as t,g as s,w as l,u as U,j as te,h as c,A as se,R as D,E as g,l as f,t as r,m as ae,J as O,n as le,q as Y,N as F,G as oe,H as ne,z as ie,_ as re}from"./index-I938XGX1.js";const de={class:"history-container"},ce={class:"page-header"},ue={class:"header-actions"},_e={class:"stat-content"},pe={class:"stat-value"},me={class:"stat-content"},fe={class:"stat-value"},ve={class:"stat-content"},ge={class:"stat-value"},ye={class:"stat-content"},he={class:"stat-value"},be={class:"query-section"},we={class:"card-header"},ze={class:"table-actions"},Ce={class:"metrics-info"},xe={class:"metric-row"},ke={class:"metric-value"},De={class:"metric-row"},Ve={class:"metric-value"},Be={class:"metric-row"},qe={class:"metrics-info"},Me={class:"metric-row"},Ne={class:"metric-value"},Pe={class:"metric-row"},Se={class:"metric-value"},He={class:"metric-row"},Ue={key:0},Oe={key:0,class:"more-issues"},Ye={key:1,class:"no-issues"},Fe={key:0,class:"pagination-container"},je=Z({__name:"History",setup(Ee){const y=C(!1),V=C(!1),_=C(["",""]),h=C(null),b=C(null),i=$({cluster_id:0,namespace:"",pod_name:"",start_time:"",end_time:"",page:1,size:20,order_by:"collected_at",order_desc:!0}),B=a=>{if(!a)return"0 B";const e=1024,p=["B","KB","MB","GB","TB"],d=Math.floor(Math.log(a)/Math.log(e));return parseFloat((a/Math.pow(e,d)).toFixed(1))+" "+p[d]},q=a=>a?a>=1e3?parseFloat((a/1e3).toFixed(2))+" 核":a+"m":"0m",M=a=>a?new Date(a).toLocaleString("zh-CN"):"-",N=a=>a<20?"low-utilization":a>80?"high-utilization":"normal-utilization",j=async()=>{try{const a=await D.getStatistics();h.value=a.data}catch(a){console.error("加载历史统计失败:",a),g.error("获取历史统计失败")}},w=async()=>{try{y.value=!0,_.value&&_.value[0]&&_.value[1]?(i.start_time=_.value[0],i.end_time=_.value[1]):(i.start_time="",i.end_time="");const a=Object.fromEntries(Object.entries(i).filter(([p,d])=>d!==""&&d!==0&&d!==void 0&&d!==null)),e=await D.queryHistory(a);b.value=e}catch(a){console.error("查询历史数据失败:",a),g.error("查询历史数据失败")}finally{y.value=!1}},E=()=>{Object.assign(i,{cluster_id:0,namespace:"",pod_name:"",start_time:"",end_time:"",page:1,size:20,order_by:"collected_at",order_desc:!0}),_.value=["",""],w()},x=async()=>{await Promise.all([j(),w()])},J=async()=>{try{V.value=!0,await D.collectData(!0),g.success("数据收集已触发"),setTimeout(()=>{x()},3e3)}catch(a){console.error("触发数据收集失败:",a),g.error("触发数据收集失败")}finally{V.value=!1}},T=async()=>{try{await ie.confirm("确定要清理30天前的历史数据吗？此操作不可撤销。","确认清理",{confirmButtonText:"清理",cancelButtonText:"取消",type:"warning"}),await D.cleanupData(30),g.success("过期数据清理成功"),await x()}catch(a){a!=="cancel"&&(console.error("清理过期数据失败:",a),g.error("清理过期数据失败"))}},I=a=>{i.size=a,i.page=1,w()},A=a=>{i.page=a,w()};return ee(()=>{x()}),(a,e)=>{const p=c("el-button"),d=c("el-card"),k=c("el-col"),G=c("el-row"),L=c("el-input-number"),z=c("el-form-item"),P=c("el-input"),R=c("el-date-picker"),K=c("el-form"),u=c("el-table-column"),S=c("el-tag"),Q=c("el-table"),W=c("el-pagination"),X=le("loading");return m(),v("div",de,[t("div",ce,[e[8]||(e[8]=t("div",{class:"header-left"},[t("h1",null,"历史数据"),t("p",{class:"subtitle"},"查看Pod资源使用的历史记录和趋势")],-1)),t("div",ue,[s(p,{onClick:x,loading:y.value,icon:U(te)},{default:l(()=>[...e[6]||(e[6]=[f(" 刷新 ",-1)])]),_:1},8,["loading","icon"]),s(p,{onClick:J,loading:V.value,icon:U(se)},{default:l(()=>[...e[7]||(e[7]=[f(" 手动收集 ",-1)])]),_:1},8,["loading","icon"])])]),s(G,{gutter:20,class:"stats-row"},{default:l(()=>[s(k,{span:6},{default:l(()=>[s(d,{class:"stat-card"},{default:l(()=>{var o;return[t("div",_e,[t("div",pe,r(((o=h.value)==null?void 0:o.total_records)||0),1),e[9]||(e[9]=t("div",{class:"stat-label"},"历史记录总数",-1))])]}),_:1})]),_:1}),s(k,{span:6},{default:l(()=>[s(d,{class:"stat-card"},{default:l(()=>{var o;return[t("div",me,[t("div",fe,r(((o=h.value)==null?void 0:o.cluster_count)||0),1),e[10]||(e[10]=t("div",{class:"stat-label"},"监控集群数",-1))])]}),_:1})]),_:1}),s(k,{span:6},{default:l(()=>[s(d,{class:"stat-card"},{default:l(()=>{var o;return[t("div",ve,[t("div",ge,r(((o=h.value)==null?void 0:o.namespace_count)||0),1),e[11]||(e[11]=t("div",{class:"stat-label"},"涉及命名空间",-1))])]}),_:1})]),_:1}),s(k,{span:6},{default:l(()=>[s(d,{class:"stat-card"},{default:l(()=>{var o;return[t("div",ye,[t("div",he,r(M((o=h.value)==null?void 0:o.latest_record)),1),e[12]||(e[12]=t("div",{class:"stat-label"},"最新记录时间",-1))])]}),_:1})]),_:1})]),_:1}),s(d,{class:"query-card"},{default:l(()=>[t("div",be,[s(K,{model:i,inline:""},{default:l(()=>[s(z,{label:"集群ID:"},{default:l(()=>[s(L,{modelValue:i.cluster_id,"onUpdate:modelValue":e[0]||(e[0]=o=>i.cluster_id=o),min:0,placeholder:"全部集群","controls-position":"right",style:{width:"120px"}},null,8,["modelValue"])]),_:1}),s(z,{label:"命名空间:"},{default:l(()=>[s(P,{modelValue:i.namespace,"onUpdate:modelValue":e[1]||(e[1]=o=>i.namespace=o),placeholder:"全部命名空间",style:{width:"140px"}},null,8,["modelValue"])]),_:1}),s(z,{label:"Pod名称:"},{default:l(()=>[s(P,{modelValue:i.pod_name,"onUpdate:modelValue":e[2]||(e[2]=o=>i.pod_name=o),placeholder:"Pod名称",style:{width:"140px"}},null,8,["modelValue"])]),_:1}),s(z,{label:"时间范围:"},{default:l(()=>[s(R,{modelValue:_.value,"onUpdate:modelValue":e[3]||(e[3]=o=>_.value=o),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"350px"}},null,8,["modelValue"])]),_:1}),s(z,null,{default:l(()=>[s(p,{type:"primary",onClick:w,loading:y.value},{default:l(()=>[...e[13]||(e[13]=[f(" 查询 ",-1)])]),_:1},8,["loading"]),s(p,{onClick:E},{default:l(()=>[...e[14]||(e[14]=[f(" 重置 ",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])]),_:1}),s(d,{class:"history-table-card"},{header:l(()=>{var o;return[t("div",we,[t("span",null,"历史记录 ("+r(((o=b.value)==null?void 0:o.total)||0)+")",1),t("div",ze,[s(p,{size:"small",onClick:T,type:"warning"},{default:l(()=>[...e[15]||(e[15]=[f(" 清理过期数据 ",-1)])]),_:1})])])]}),default:l(()=>{var o;return[ae((m(),Y(Q,{data:((o=b.value)==null?void 0:o.data)||[],style:{width:"100%"},"empty-text":"暂无历史数据"},{default:l(()=>[s(u,{prop:"cluster_id",label:"集群ID",width:"80",align:"center"}),s(u,{prop:"namespace",label:"命名空间",width:"120"}),s(u,{prop:"pod_name",label:"Pod名称",width:"180","show-overflow-tooltip":""}),s(u,{prop:"node_name",label:"节点",width:"120","show-overflow-tooltip":""}),s(u,{label:"内存指标",width:"180",align:"center"},{default:l(({row:n})=>[t("div",Ce,[t("div",xe,[e[16]||(e[16]=t("span",{class:"metric-label"},"使用:",-1)),t("span",ke,r(B(n.memory_usage)),1)]),t("div",De,[e[17]||(e[17]=t("span",{class:"metric-label"},"请求:",-1)),t("span",Ve,r(B(n.memory_request)),1)]),t("div",Be,[e[18]||(e[18]=t("span",{class:"metric-label"},"利用率:",-1)),t("span",{class:F(["metric-value",N(n.memory_req_pct)])},r(n.memory_req_pct.toFixed(1))+"% ",3)])])]),_:1}),s(u,{label:"CPU指标",width:"180",align:"center"},{default:l(({row:n})=>[t("div",qe,[t("div",Me,[e[19]||(e[19]=t("span",{class:"metric-label"},"使用:",-1)),t("span",Ne,r(q(n.cpu_usage)),1)]),t("div",Pe,[e[20]||(e[20]=t("span",{class:"metric-label"},"请求:",-1)),t("span",Se,r(q(n.cpu_request)),1)]),t("div",He,[e[21]||(e[21]=t("span",{class:"metric-label"},"利用率:",-1)),t("span",{class:F(["metric-value",N(n.cpu_req_pct)])},r(n.cpu_req_pct.toFixed(1))+"% ",3)])])]),_:1}),s(u,{prop:"status",label:"状态",width:"80",align:"center"},{default:l(({row:n})=>[s(S,{type:n.status==="reasonable"?"success":"warning",size:"small"},{default:l(()=>[f(r(n.status==="reasonable"?"合理":"不合理"),1)]),_:2},1032,["type"])]),_:1}),s(u,{prop:"collected_at",label:"收集时间",width:"160"},{default:l(({row:n})=>[f(r(M(n.collected_at)),1)]),_:1}),s(u,{label:"问题","min-width":"200"},{default:l(({row:n})=>[n.issues&&JSON.parse(n.issues).length>0?(m(),v("div",Ue,[(m(!0),v(oe,null,ne(JSON.parse(n.issues).slice(0,2),H=>(m(),Y(S,{key:H,type:"warning",size:"small",class:"issue-tag"},{default:l(()=>[f(r(H),1)]),_:2},1024))),128)),JSON.parse(n.issues).length>2?(m(),v("span",Oe," +"+r(JSON.parse(n.issues).length-2)+"个 ",1)):O("",!0)])):(m(),v("span",Ye,"无问题"))]),_:1})]),_:1},8,["data"])),[[X,y.value]]),b.value?(m(),v("div",Fe,[s(W,{"current-page":i.page,"onUpdate:currentPage":e[4]||(e[4]=n=>i.page=n),"page-size":i.size,"onUpdate:pageSize":e[5]||(e[5]=n=>i.size=n),"page-sizes":[10,20,50,100],total:b.value.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:I,onCurrentChange:A},null,8,["current-page","page-size","total"])])):O("",!0)]}),_:1})])}}}),Te=re(je,[["__scopeId","data-v-b4f745ed"]]);export{Te as default};
