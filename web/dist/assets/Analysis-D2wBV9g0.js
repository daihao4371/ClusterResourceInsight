import{d as se,r as x,a as I,c as S,o as ae,b as F,e as h,f as t,g as a,w as o,u as y,j as le,h as c,A as oe,B as ne,E as M,l as w,s as ie,t as i,C as re,D as ce,F as de,G as A,H as D,y as ue,m as _e,n as pe,q,_ as me}from"./index-I938XGX1.js";const ve={class:"analysis-container"},fe={class:"page-header"},ge={class:"header-actions"},he={class:"stat-content"},ye={class:"stat-icon clusters-icon"},be={class:"stat-info"},xe={class:"stat-value"},we={class:"stat-content"},Ce={class:"stat-icon pods-icon"},Pe={class:"stat-info"},ke={class:"stat-value"},ze={class:"stat-content"},Ue={class:"stat-icon problems-icon"},Se={class:"stat-info"},Fe={class:"stat-value"},Me={class:"stat-content"},qe={class:"stat-icon health-icon"},Be={class:"stat-info"},Ve={class:"stat-value"},Ae={class:"filter-section"},De={class:"filter-group"},Le={class:"filter-group"},je={class:"filter-group"},Te={class:"filter-group"},Re={class:"card-header"},Ee={class:"table-actions"},Ne={class:"pod-details"},Ie={class:"detail-section"},Oe={class:"resource-progress"},Ge={class:"progress-item"},$e={class:"progress-text"},He={class:"progress-item"},Ke={class:"progress-text"},Je={class:"detail-section"},Qe={class:"resource-progress"},We={class:"progress-item"},Xe={class:"progress-text"},Ye={class:"progress-item"},Ze={class:"progress-text"},et={class:"resource-info"},tt={class:"usage-text"},st={class:"request-text"},at={class:"resource-info"},lt={class:"usage-text"},ot={class:"request-text"},nt={class:"issues-container"},it={class:"pagination-container"},rt=se({__name:"Analysis",setup(ct){const P=x(!1),B=x(!1),k=x(!1),v=x(null),z=x([]),b=x([]),r=I({cluster:"",namespace:"",issueType:"",search:""}),u=I({currentPage:1,pageSize:20}),O=S(()=>{if(!v.value||v.value.total_pods===0)return 100;const l=v.value.total_pods-v.value.unreasonable_pods;return Math.round(l/v.value.total_pods*100)}),G=S(()=>{const l=new Set(z.value.map(e=>e.cluster_name));return Array.from(l).sort()}),$=S(()=>{const l=new Set(z.value.map(e=>e.namespace));return Array.from(l).sort()}),H=S(()=>{const l=(u.currentPage-1)*u.pageSize,e=l+u.pageSize;return b.value.slice(l,e)}),L=l=>{if(l===0)return"0 B";const e=1024,d=["B","KB","MB","GB","TB"],f=Math.floor(Math.log(l)/Math.log(e));return parseFloat((l/Math.pow(e,f)).toFixed(2))+" "+d[f]},j=l=>l>=1e3?parseFloat((l/1e3).toFixed(2))+" 核":l+"m",T=l=>new Date(l).toLocaleString("zh-CN"),R=async()=>{try{P.value=!0;const l=await ne.getAnalysis();v.value=l,z.value=l.top50_problems||[],C(),M.success("分析数据加载完成")}catch(l){console.error("加载分析数据失败:",l),M.error("获取分析数据失败")}finally{P.value=!1}},C=()=>{let l=[...z.value];if(r.cluster&&(l=l.filter(e=>e.cluster_name===r.cluster)),r.namespace&&(l=l.filter(e=>e.namespace===r.namespace)),r.issueType&&(l=l.filter(e=>e.issues.some(d=>d.includes(r.issueType)))),r.search){const e=r.search.toLowerCase();l=l.filter(d=>d.pod_name.toLowerCase().includes(e)||d.node_name.toLowerCase().includes(e))}b.value=l,u.currentPage=1},K=()=>{R()},J=async()=>{try{B.value=!0;const l=["集群","命名空间","Pod名称","节点名称","内存使用(MB)","内存请求(MB)","内存利用率(%)","CPU使用(m)","CPU请求(m)","CPU利用率(%)","状态","问题描述","创建时间"],e=b.value.map(n=>[n.cluster_name,n.namespace,n.pod_name,n.node_name,Math.round(n.memory_usage/1024/1024),Math.round(n.memory_request/1024/1024),n.memory_req_pct.toFixed(1),n.cpu_usage,n.cpu_request,n.cpu_req_pct.toFixed(1),n.status,n.issues.join(";"),T(n.creation_time)]),d=[l,...e].map(n=>n.map(_=>`"${_}"`).join(",")).join(`
`),f=new Blob(["\uFEFF"+d],{type:"text/csv;charset=utf-8"}),g=window.URL.createObjectURL(f),p=document.createElement("a");p.href=g,p.download=`pod-analysis-report-${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.csv`,p.click(),window.URL.revokeObjectURL(g),M.success("报告导出成功")}catch(l){console.error("导出报告失败:",l),M.error("导出报告失败")}finally{B.value=!1}},Q=()=>{k.value=!k.value},W=l=>{u.pageSize=l,u.currentPage=1},X=l=>{u.currentPage=l};return ae(()=>{R()}),(l,e)=>{const d=c("el-button"),f=c("el-icon"),g=c("el-card"),p=c("el-col"),n=c("el-row"),_=c("el-option"),V=c("el-select"),Y=c("el-input"),U=c("el-progress"),m=c("el-table-column"),E=c("el-tag"),Z=c("el-table"),ee=c("el-pagination"),te=pe("loading");return h(),F("div",ve,[t("div",fe,[e[8]||(e[8]=t("div",{class:"header-left"},[t("h1",null,"Pod资源分析"),t("p",{class:"subtitle"},"分析集群中Pod的资源使用情况和配置合理性")],-1)),t("div",ge,[a(d,{type:"primary",onClick:K,loading:P.value,icon:y(le)},{default:o(()=>[...e[6]||(e[6]=[w(" 刷新分析 ",-1)])]),_:1},8,["loading","icon"]),a(d,{onClick:J,loading:B.value,icon:y(oe)},{default:o(()=>[...e[7]||(e[7]=[w(" 导出报告 ",-1)])]),_:1},8,["loading","icon"])])]),a(n,{gutter:20,class:"analysis-stats"},{default:o(()=>[a(p,{span:6},{default:o(()=>[a(g,{class:"stat-card"},{default:o(()=>{var s;return[t("div",he,[t("div",ye,[a(f,null,{default:o(()=>[a(y(ie))]),_:1})]),t("div",be,[t("div",xe,i(((s=v.value)==null?void 0:s.clusters_analyzed)||0),1),e[9]||(e[9]=t("div",{class:"stat-label"},"分析集群",-1))])])]}),_:1})]),_:1}),a(p,{span:6},{default:o(()=>[a(g,{class:"stat-card"},{default:o(()=>{var s;return[t("div",we,[t("div",Ce,[a(f,null,{default:o(()=>[a(y(re))]),_:1})]),t("div",Pe,[t("div",ke,i(((s=v.value)==null?void 0:s.total_pods)||0),1),e[10]||(e[10]=t("div",{class:"stat-label"},"总Pod数",-1))])])]}),_:1})]),_:1}),a(p,{span:6},{default:o(()=>[a(g,{class:"stat-card"},{default:o(()=>{var s;return[t("div",ze,[t("div",Ue,[a(f,null,{default:o(()=>[a(y(ce))]),_:1})]),t("div",Se,[t("div",Fe,i(((s=v.value)==null?void 0:s.unreasonable_pods)||0),1),e[11]||(e[11]=t("div",{class:"stat-label"},"问题Pod",-1))])])]}),_:1})]),_:1}),a(p,{span:6},{default:o(()=>[a(g,{class:"stat-card"},{default:o(()=>[t("div",Me,[t("div",qe,[a(f,null,{default:o(()=>[a(y(de))]),_:1})]),t("div",Be,[t("div",Ve,i(O.value)+"%",1),e[12]||(e[12]=t("div",{class:"stat-label"},"健康比例",-1))])])]),_:1})]),_:1})]),_:1}),a(g,{class:"filter-card"},{default:o(()=>[t("div",Ae,[t("div",De,[e[13]||(e[13]=t("label",null,"集群筛选:",-1)),a(V,{modelValue:r.cluster,"onUpdate:modelValue":e[0]||(e[0]=s=>r.cluster=s),placeholder:"全部集群",clearable:"",onChange:C},{default:o(()=>[a(_,{label:"全部集群",value:""}),(h(!0),F(A,null,D(G.value,s=>(h(),q(_,{key:s,label:s,value:s},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),t("div",Le,[e[14]||(e[14]=t("label",null,"命名空间:",-1)),a(V,{modelValue:r.namespace,"onUpdate:modelValue":e[1]||(e[1]=s=>r.namespace=s),placeholder:"全部命名空间",clearable:"",onChange:C},{default:o(()=>[a(_,{label:"全部命名空间",value:""}),(h(!0),F(A,null,D($.value,s=>(h(),q(_,{key:s,label:s,value:s},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),t("div",je,[e[15]||(e[15]=t("label",null,"问题类型:",-1)),a(V,{modelValue:r.issueType,"onUpdate:modelValue":e[2]||(e[2]=s=>r.issueType=s),placeholder:"全部问题",clearable:"",onChange:C},{default:o(()=>[a(_,{label:"全部问题",value:""}),a(_,{label:"内存利用率过低",value:"内存利用率过低"}),a(_,{label:"CPU利用率过低",value:"CPU利用率过低"}),a(_,{label:"资源配置缺失",value:"资源配置缺失"}),a(_,{label:"配置差异过大",value:"配置差异过大"})]),_:1},8,["modelValue"])]),t("div",Te,[a(Y,{modelValue:r.search,"onUpdate:modelValue":e[3]||(e[3]=s=>r.search=s),placeholder:"搜索Pod名称...","prefix-icon":y(ue),clearable:"",onInput:C},null,8,["modelValue","prefix-icon"])])])]),_:1}),a(g,{class:"pods-table-card"},{header:o(()=>[t("div",Re,[t("span",null,"问题Pod列表 ("+i(b.value.length)+")",1),t("div",Ee,[a(d,{size:"small",onClick:Q},{default:o(()=>[w(i(k.value?"收起详情":"展开详情"),1)]),_:1})])])]),default:o(()=>[_e((h(),q(Z,{data:H.value,style:{width:"100%"},"empty-text":"暂无问题Pod数据","row-key":"pod_name","expand-row-keys":k.value?b.value.map(s=>s.pod_name):[]},{default:o(()=>[a(m,{type:"expand"},{default:o(({row:s})=>[t("div",Ne,[a(n,{gutter:20},{default:o(()=>[a(p,{span:12},{default:o(()=>[t("div",Ie,[e[18]||(e[18]=t("h4",null,"内存使用情况",-1)),t("div",Oe,[t("div",Ge,[e[16]||(e[16]=t("span",null,"请求利用率:",-1)),a(U,{percentage:Math.min(s.memory_req_pct,100),status:s.memory_req_pct<20?"exception":"success","stroke-width":8},{default:o(()=>[t("span",$e,i(s.memory_req_pct.toFixed(1))+"%",1)]),_:2},1032,["percentage","status"])]),t("div",He,[e[17]||(e[17]=t("span",null,"限制利用率:",-1)),a(U,{percentage:Math.min(s.memory_limit_pct,100),status:s.memory_limit_pct<15?"exception":"success","stroke-width":8},{default:o(()=>[t("span",Ke,i(s.memory_limit_pct.toFixed(1))+"%",1)]),_:2},1032,["percentage","status"])])])])]),_:2},1024),a(p,{span:12},{default:o(()=>[t("div",Je,[e[21]||(e[21]=t("h4",null,"CPU使用情况",-1)),t("div",Qe,[t("div",We,[e[19]||(e[19]=t("span",null,"请求利用率:",-1)),a(U,{percentage:Math.min(s.cpu_req_pct,100),status:s.cpu_req_pct<15?"exception":"success","stroke-width":8},{default:o(()=>[t("span",Xe,i(s.cpu_req_pct.toFixed(1))+"%",1)]),_:2},1032,["percentage","status"])]),t("div",Ye,[e[20]||(e[20]=t("span",null,"限制利用率:",-1)),a(U,{percentage:Math.min(s.cpu_limit_pct,100),status:s.cpu_limit_pct<10?"exception":"success","stroke-width":8},{default:o(()=>[t("span",Ze,i(s.cpu_limit_pct.toFixed(1))+"%",1)]),_:2},1032,["percentage","status"])])])])]),_:2},1024)]),_:2},1024)])]),_:1}),a(m,{prop:"cluster_name",label:"集群",width:"100"}),a(m,{prop:"namespace",label:"命名空间",width:"120"}),a(m,{prop:"pod_name",label:"Pod名称",width:"200","show-overflow-tooltip":""}),a(m,{prop:"node_name",label:"节点",width:"120","show-overflow-tooltip":""}),a(m,{label:"内存使用",width:"120",align:"center"},{default:o(({row:s})=>[t("div",et,[t("div",tt,i(L(s.memory_usage)),1),t("div",st,"请求: "+i(L(s.memory_request)),1)])]),_:1}),a(m,{label:"CPU使用",width:"120",align:"center"},{default:o(({row:s})=>[t("div",at,[t("div",lt,i(j(s.cpu_usage)),1),t("div",ot,"请求: "+i(j(s.cpu_request)),1)])]),_:1}),a(m,{prop:"status",label:"状态",width:"80",align:"center"},{default:o(({row:s})=>[a(E,{type:s.status==="合理"?"success":"danger",size:"small"},{default:o(()=>[w(i(s.status),1)]),_:2},1032,["type"])]),_:1}),a(m,{prop:"issues",label:"问题描述","min-width":"200"},{default:o(({row:s})=>[t("div",nt,[(h(!0),F(A,null,D(s.issues,N=>(h(),q(E,{key:N,type:"warning",size:"small",class:"issue-tag"},{default:o(()=>[w(i(N),1)]),_:2},1024))),128))])]),_:1}),a(m,{prop:"creation_time",label:"创建时间",width:"160"},{default:o(({row:s})=>[w(i(T(s.creation_time)),1)]),_:1})]),_:1},8,["data","expand-row-keys"])),[[te,P.value]]),t("div",it,[a(ee,{"current-page":u.currentPage,"onUpdate:currentPage":e[4]||(e[4]=s=>u.currentPage=s),"page-size":u.pageSize,"onUpdate:pageSize":e[5]||(e[5]=s=>u.pageSize=s),"page-sizes":[10,20,50,100],total:b.value.length,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:W,onCurrentChange:X},null,8,["current-page","page-size","total"])])]),_:1})])}}}),ut=me(rt,[["__scopeId","data-v-ddd8b4db"]]);export{ut as default};
